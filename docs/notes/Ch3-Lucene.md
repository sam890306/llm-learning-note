ç†è§£ **Lucene** æ˜¯ç†è§£ **Elasticsearch** çš„å…³é”®ï¼Œå› ä¸º Elasticsearch å…¶å®åªæ˜¯ Lucene çš„**åˆ†å¸ƒå¼å°è£…å±‚ + REST API å¤–å£³**ã€‚
ä¸‹é¢æˆ‘ä»¬ä»åŸç†ã€æ¶æ„ã€ä¸ DDIAï¼ˆã€ŠDesigning Data-Intensive Applicationsã€‹ï¼‰å¯¹åº”å…³ç³»ä¸‰ä¸ªç»´åº¦è®²æ¸…æ¥šã€‚

---

## ğŸ§© ä¸€ã€Lucene æ˜¯ä»€ä¹ˆ

> **Lucene æ˜¯ä¸€ä¸ªå¼€æºçš„å…¨æ–‡æ£€ç´¢å¼•æ“åº“ï¼ˆlibraryï¼‰ï¼Œç”± Apache åŸºé‡‘ä¼šç»´æŠ¤ï¼Œç”¨ Java ç¼–å†™ã€‚**

å®ƒä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„â€œæœåŠ¡â€æˆ–â€œæ•°æ®åº“â€ï¼Œè€Œæ˜¯ä¸€ä¸ª**åµŒå…¥å¼ä¿¡æ¯æ£€ç´¢å¼•æ“æ ¸å¿ƒ**ï¼š
ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œ**æœç´¢å¼•æ“å†…æ ¸ï¼ˆSearch Engine Kernelï¼‰**â€ã€‚

Elasticsearchã€Solr ç­‰ç³»ç»Ÿéƒ½æ˜¯åœ¨ Lucene ä¹‹ä¸Šå°è£…å‡ºæ¥çš„ã€‚

---

## ğŸ§  äºŒã€Lucene çš„æ ¸å¿ƒæ€æƒ³

Lucene çš„åŸºæœ¬ç†å¿µå¯ä»¥ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> **â€œæŠŠæ–‡æœ¬è½¬åŒ–æˆå€’æ’ç´¢å¼•ï¼ˆinverted indexï¼‰ï¼Œå†ç”¨å€’æ’ç´¢å¼•å®ç°é«˜æ•ˆæœç´¢ã€‚â€**

è¿™å°±åƒæœç´¢å¼•æ“çš„æ ¸å¿ƒæ€æƒ³ï¼š
ä¸æ˜¯ä¿å­˜æ•´ç¯‡æ–‡æ¡£ï¼Œè€Œæ˜¯ä¿å­˜â€œè¯ â†’ æ–‡æ¡£â€çš„æ˜ å°„ã€‚

ä¾‹å¦‚ä¸‰ç¯‡æ–‡æ¡£ï¼š

| æ–‡æ¡£ID | å†…å®¹                                    |
| ---- | ------------------------------------- |
| 1    | I love data systems                   |
| 2    | Designing Data-Intensive Applications |
| 3    | I design systems for data             |

Lucene ä¼šæ„å»ºä¸€ä¸ªå€’æ’è¡¨ï¼ˆinverted indexï¼‰ï¼š

| è¯ (term)     | å‡ºç°çš„æ–‡æ¡£ID |
| ------------ | ------- |
| I            | [1, 3]  |
| love         | [1]     |
| data         | [1, 3]  |
| systems      | [1, 3]  |
| design       | [3]     |
| designing    | [2]     |
| applications | [2]     |
| intensive    | [2]     |

è¿™å¼ è¡¨ä½¿å¾—â€œæœç´¢ data systemsâ€å¯ä»¥å¿«é€Ÿé€šè¿‡äº¤é›† `[1,3] âˆ© [1,3] = [1,3]` å¾—åˆ°ç»“æœã€‚

---

## âš™ï¸ ä¸‰ã€Lucene çš„ä¸»è¦ç»„ä»¶

| æ¨¡å—                              | ä½œç”¨                                              |
| ------------------------------- | ----------------------------------------------- |
| **Analyzer**                    | æŠŠåŸå§‹æ–‡æœ¬åˆ‡è¯ã€å»åœç”¨è¯ã€åšè¯å¹²åŒ–ï¼ˆtokenization & normalizationï¼‰ |
| **IndexWriter**                 | æŠŠæ–‡æ¡£å†™å…¥ç´¢å¼•ï¼ˆç”Ÿæˆå€’æ’è¡¨ã€posting listï¼‰                     |
| **IndexReader / IndexSearcher** | è¯»å–ç´¢å¼•å¹¶æ‰§è¡Œæœç´¢ã€æ‰“åˆ†ã€æ’åº                                 |
| **Segment**                     | ä¸å¯å˜çš„ç´¢å¼•æ–‡ä»¶ï¼ˆç±»ä¼¼ LSM æ ‘çš„ SSTableï¼‰                     |
| **MergePolicy**                 | å®šæœŸåˆå¹¶æ—§ Segment å‡å°‘ç¢ç‰‡                              |
| **Document / Field / Term**     | æ•°æ®ç»“æ„åŒ–å•å…ƒ                                         |

---

## ğŸ§± å››ã€Lucene çš„å­˜å‚¨æ¨¡å‹ï¼šLog-Structured + Immutable Segment

Lucene é‡‡ç”¨**æ—¥å¿—ç»“æ„ï¼ˆLog-Structuredï¼‰**å­˜å‚¨æ¨¡å‹ï¼Œä¸ DDIA ç¬¬3ç« â€œå­˜å‚¨ä¸ç´¢å¼•ç»“æ„â€å®Œå…¨ä¸€è‡´ã€‚

å†™å…¥æ—¶ï¼š

1. æ–°æ–‡æ¡£å…ˆå†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆRAM bufferï¼‰ã€‚
2. å½“ buffer æ»¡æ—¶è§¦å‘ **flush**ï¼š

   * æŠŠç¼“å†²åŒºè½¬åŒ–ä¸ºä¸€ä¸ªæ–°çš„ **Segment æ–‡ä»¶**ï¼›
   * Segment ä¸å¯å˜ï¼ˆimmutableï¼‰ã€‚
3. åå°çº¿ç¨‹å‘¨æœŸæ€§æ‰§è¡Œ **merge**ï¼š

   * æŠŠå¤šä¸ªå° Segment åˆå¹¶ä¸ºå¤§ Segmentï¼›
   * åˆ é™¤è¿‡æœŸæˆ–è¢«æ›´æ–°çš„æ–‡æ¡£ã€‚

è¿™ä¸ **LSM-Treeï¼ˆLog-Structured Merge-Treeï¼‰** çš„æ€è·¯å‡ ä¹ä¸€æ ·ï¼š
â€œ**å†™å…¥ append-onlyï¼ŒæŸ¥è¯¢ä¾é åˆå¹¶æœ‰åºæ®µã€‚**â€

---

## ğŸ“‚ äº”ã€Lucene ç´¢å¼•æ–‡ä»¶ç»“æ„ï¼ˆç®€åŒ–ï¼‰

æ¯ä¸ª Segment åŒ…å«å¤šä¸ªæ–‡ä»¶ï¼ˆå®é™…å‡ åä¸ªï¼‰ï¼Œæ ¸å¿ƒå¦‚ä¸‹ï¼š

| æ–‡ä»¶              | å†…å®¹                         |
| --------------- | -------------------------- |
| `.tim`          | term dictionaryï¼ˆè®°å½•æ‰€æœ‰è¯ï¼‰     |
| `.doc`          | posting listï¼ˆterm å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨ï¼‰ |
| `.pos`          | term åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ï¼ˆç”¨äºçŸ­è¯­æŸ¥è¯¢ï¼‰       |
| `.fdx` / `.fdt` | å­˜å‚¨åŸå§‹æ–‡æ¡£å­—æ®µ                   |
| `.del`          | åˆ é™¤æ ‡è®°æ–‡ä»¶ï¼ˆå› ä¸º segment ä¸å¯å˜ï¼‰     |

Lucene çš„è®¾è®¡å“²å­¦æ˜¯â€œ**å°è€Œç²¾ã€åªè¿½åŠ ã€ä¸å¯å˜**â€ï¼Œ
æ‰€æœ‰å¤æ‚çš„åŠŸèƒ½ï¼ˆæ›´æ–°ã€åˆ é™¤ã€äº‹åŠ¡æ¢å¤ï¼‰éƒ½åœ¨æ›´é«˜å±‚ï¼ˆå¦‚ Elasticsearchï¼‰å°è£…ã€‚

---

## ğŸ”„ å…­ã€Lucene ä¸ Elasticsearch çš„å…³ç³»

| å±‚çº§      | ç»„ä»¶            | åŠŸèƒ½                                 |
| ------- | ------------- | ---------------------------------- |
| ğŸ§  ç”¨æˆ·æ¥å£ | Elasticsearch | REST APIã€åˆ†å¸ƒå¼åè°ƒã€èšåˆã€å¤åˆ¶ã€ç¼“å­˜            |
| âš™ï¸ ç´¢å¼•å¼•æ“ | **Lucene**    | å€’æ’ç´¢å¼•ã€æ‰“åˆ†ã€åˆå¹¶ã€æ–‡æ¡£ç®¡ç†                    |
| ğŸ’¾ å­˜å‚¨å±‚  | Filesystem    | å­˜ Segment æ–‡ä»¶ã€translogã€commit point |

ç®€è€Œè¨€ä¹‹ï¼š

> Elasticsearch è´Ÿè´£ **åˆ†å¸ƒå¼è°ƒåº¦ + é«˜çº§åŠŸèƒ½**ï¼Œ
> Lucene è´Ÿè´£ **åº•å±‚æœç´¢ä¸ç´¢å¼•**ã€‚

æ¯ä¸ª Elasticsearch shard å®é™…å°±æ˜¯ä¸€ä¸ª Lucene ç´¢å¼•å®ä¾‹ã€‚

---

## ğŸ” ä¸ƒã€Lucene çš„â€œå†™å‰æ—¥å¿—â€è¯­ä¹‰ï¼ˆä¸ Elasticsearch çš„å…³ç³»ï¼‰

Lucene æœ¬èº«æ²¡æœ‰ WALï¼Œè€Œæ˜¯æä¾› **commit point** æ¦‚å¿µï¼š

* å½“ commit æ—¶ï¼Œä¼š fsync æ‰€æœ‰ segment + å†™å…¥ `segments_N` æ–‡ä»¶ï¼›
* è¿™ä»½æ–‡ä»¶æè¿°å½“å‰ç´¢å¼•çš„æ‰€æœ‰ segment åˆ—è¡¨ï¼›
* å®•æœºåï¼ŒLucene æ ¹æ®æœ€æ–°çš„ `segments_N` æ¢å¤çŠ¶æ€ã€‚

Elasticsearch åœ¨ Lucene ä¹‹ä¸Šå¢åŠ  **Translog**ï¼ˆWrite-Ahead Logï¼‰ï¼Œ
ç¡®ä¿æ¯æ¬¡å†™å…¥æ“ä½œåœ¨ flush å‰éƒ½æœ‰å¯æ¢å¤æ—¥å¿—ï¼ˆè§ä¸Šä¸€é—®ï¼‰ã€‚

---

## ğŸ§¬ å…«ã€DDIA è§†è§’ä¸‹çš„ Lucene

| DDIA æŠ½è±¡         | Lucene å¯¹åº”              | è¯´æ˜         |
| --------------- | ---------------------- | ---------- |
| Append-only log | æ–° segment æ–‡ä»¶           | æ‰€æœ‰å†™å…¥éƒ½æ˜¯è¿½åŠ å¼  |
| MemTable        | RAM buffer             | å†…å­˜æš‚å­˜åŒº      |
| SSTable         | Segment æ–‡ä»¶             | æœ‰åºã€ä¸å¯å˜     |
| Compaction      | Segment merge          | æ¸…ç†æ—§ç‰ˆæœ¬ã€å‹ç¼©ç´¢å¼• |
| Checkpoint      | `segments_N` æ–‡ä»¶        | è¡¨ç¤ºä¸€è‡´æ€§è¾¹ç•Œ    |
| WAL             | Elasticsearch Translog | ä¸Šå±‚å°è£…ä¿è¯æ¢å¤   |

Lucene ä»£è¡¨äº† DDIA æ‰€è¯´çš„â€œ**æ—¥å¿—ç»“æ„å­˜å‚¨ï¼ˆLog-Structured Storage Engineï¼‰**â€çš„æœ€çº¯ç²¹å½¢æ€ã€‚

---

## ğŸ§  ä¹ã€Lucene çš„è®¾è®¡å“²å­¦

1. **Immutable Everything** â†’ ç®€åŒ–å¹¶å‘ä¸ä¸€è‡´æ€§ï¼›
2. **Append-Only + Merge** â†’ é«˜å†™å…¥ååï¼›
3. **Index-Time Compute, Query-Time Merge** â†’ ä»¥ç©ºé—´æ¢æ—¶é—´ï¼›
4. **Segment as Unit of Recovery** â†’ è½»é‡ checkpointï¼›
5. **Separation of Concerns** â†’ å¼•æ“å†…æ ¸ä¸åˆ†å¸ƒå¼ç³»ç»Ÿè§£è€¦ã€‚

è¿™äº›ç†å¿µåœ¨ DDIA çš„ç¬¬3ç« ã€ç¬¬5ç« ã€ç¬¬10ç« éƒ½æœ‰ä½“ç°ã€‚

---

## âœ… åã€æ€»ç»“ä¸€å¥è¯

> **Lucene æ˜¯ä¿¡æ¯æ£€ç´¢ç•Œçš„ LevelDB æˆ– RocksDBã€‚**
>
> å®ƒä»¥**å€’æ’ç´¢å¼•**ä»£æ›¿é”®å€¼ç´¢å¼•ï¼Œä»¥**Segment æ–‡ä»¶**ä»£æ›¿è¡¨æ ¼ï¼Œä»¥**Merge Policy**ä»£æ›¿ Compactionã€‚
>
> Elasticsearchã€Solrã€OpenSearch ç­‰ç³»ç»Ÿï¼Œåªæ˜¯åœ¨ Lucene çš„åŸºç¡€ä¸ŠåŠ ä¸Šï¼š
>
> * **åˆ†å¸ƒå¼åè°ƒï¼ˆshard + replicaï¼‰**
> * **REST API**
> * **ç¼“å­˜ä¸èšåˆå±‚**
> * **WAL ä¸æ¢å¤æœºåˆ¶**
>
> Lucene æ˜¯â€œå­˜å‚¨å¼•æ“â€ï¼ŒElasticsearch æ˜¯â€œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿâ€ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘æ¥ç€ç”»å‡ºä¸€å¼ å›¾ï¼Œå±•ç¤º **â€œLucene + Elasticsearch çš„å±‚æ¬¡å…³ç³»â€**ï¼ˆå« RAM bufferã€segmentã€translogã€replica ç­‰ï¼‰ï¼Ÿ
